name: Auto Release on Script Updates

on:
  push:
    branches: [ main ]
    paths:
      - 'Install-Office.ps1'
      - 'Install-Office-SAFE.bat'
      - 'Install-Office-GUI-WPF.ps1'
      - 'Install-Office-GUI-SAFE.bat'
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Debug - Check files exist
      run: |
        echo "Checking if files exist..."
        ls -la
        if [ -f "Install-Office.ps1" ]; then
          echo "âœ… Install-Office.ps1 found"
        else
          echo "âŒ Install-Office.ps1 NOT found"
        fi
        if [ -f "Install-Office-SAFE.bat" ]; then
          echo "âœ… Install-Office-SAFE.bat found"
        else
          echo "âŒ Install-Office-SAFE.bat NOT found"
        fi
        if [ -f "Install-Office-GUI-WPF.ps1" ]; then
          echo "âœ… Install-Office-GUI-WPF.ps1 found"
        else
          echo "âŒ Install-Office-GUI-WPF.ps1 NOT found"
        fi
        if [ -f "Install-Office-GUI-SAFE.bat" ]; then
          echo "âœ… Install-Office-GUI-SAFE.bat found"
        else
          echo "âŒ Install-Office-GUI-SAFE.bat NOT found"
        fi

    - name: Extract version from PowerShell script
      id: get_version
      run: |
        # Try to extract version from PowerShell script
        if [ -f "Install-Office.ps1" ] && grep -q 'v[0-9]\+\.[0-9]\+' Install-Office.ps1; then
          VERSION=$(grep -o 'v[0-9]\+\.[0-9]\+[^"]*' Install-Office.ps1 | head -1 | sed 's/[^v0-9\.]//g')
        else
          # Fallback to date-based versioning
          VERSION="v$(date +'%Y.%m.%d')"
        fi
        
        echo "Extracted version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Check if release exists
      id: check_release
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        echo "Checking if release $VERSION exists..."
        
        # Check if release already exists
        if gh release view "$VERSION" >/dev/null 2>&1; then
          echo "Release $VERSION already exists, creating incremental version"
          COUNTER=1
          while gh release view "$VERSION-$COUNTER" >/dev/null 2>&1; do
            COUNTER=$((COUNTER + 1))
          done
          VERSION="$VERSION-$COUNTER"
        fi
        
        echo "final_version=$VERSION" >> $GITHUB_OUTPUT
        echo "Final version: $VERSION"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create release packages
      run: |
        VERSION="${{ steps.check_release.outputs.final_version }}"
        echo "Creating release packages for version: $VERSION"
        
        # Create Console version package
        mkdir -p release-package-console
        if [ -f "Install-Office.ps1" ]; then
          cp Install-Office.ps1 release-package-console/
          echo "âœ… Copied Install-Office.ps1"
        fi
        if [ -f "Install-Office-SAFE.bat" ]; then
          cp Install-Office-SAFE.bat release-package-console/
          echo "âœ… Copied Install-Office-SAFE.bat"
        fi
        
        # Create GUI version package
        mkdir -p release-package-gui
        if [ -f "Install-Office-GUI-WPF.ps1" ]; then
          cp Install-Office-GUI-WPF.ps1 release-package-gui/
          echo "âœ… Copied Install-Office-GUI-WPF.ps1"
        fi
        if [ -f "Install-Office-GUI-SAFE.bat" ]; then
          cp Install-Office-GUI-SAFE.bat release-package-gui/
          echo "âœ… Copied Install-Office-GUI-SAFE.bat"
        fi
        
        # Create comprehensive README for Console package
        if [ -d "release-package-console" ] && [ "$(ls -A release-package-console)" ]; then
          cat > release-package-console/README.txt << EOF
        Office Auto Installer - Console Version Package - $VERSION
        ================================================================

        QUICK START INSTRUCTIONS:
        1. Extract both files to the same folder (like Downloads)
        2. Double-click "Install-Office-SAFE.bat" to start
        3. Click "Yes" when Windows asks for admin permission
        4. Follow the simple prompts to install Office

        WHAT'S INCLUDED:
        - Install-Office-SAFE.bat (Launcher - fixes PowerShell issues)
        - Install-Office.ps1 (Main console installer script)
        - README.txt (This file with instructions)

        SYSTEM REQUIREMENTS:
        - Windows 10/11 (Windows 7/8 may work)
        - 4GB+ free disk space
        - 2GB+ RAM recommended
        - Internet connection (Office downloads during install)
        - Administrator privileges

        SUPPORTED OFFICE VERSIONS:
        - Office 2024 Pro Plus (Latest - Recommended)
        - Office LTSC 2021 (Stable long-term version)
        - Microsoft 365 Apps (Cloud-connected)

        SUPPORTED LANGUAGES:
        - English (US/UK), French, German, Dutch, Spanish, Portuguese

        OPTIONAL COMPONENTS:
        - Visio Professional (Diagrams and flowcharts)
        - Project Professional (Project management)

        TROUBLESHOOTING:
        If you have problems:
        1. Make sure both files are in the same folder
        2. Right-click the .bat file and "Run as administrator"
        3. Temporarily disable antivirus during installation
        4. Check your internet connection

        For more help, visit: https://njvanas.github.io/Office-Auto-Install/

        IMPORTANT DISCLAIMER:
        This tool uses Microsoft's official Office Deployment Tool.
        You are responsible for having proper Office licenses.
        This does not crack, modify, or bypass any licensing.

        Licensed under MIT License
        Copyright (c) 2025 Dolfie
        EOF
          
          # Create Console ZIP package
          cd release-package-console
          zip -r "../Office-Auto-Installer-Console-$VERSION.zip" .
          cd ..
          echo "âœ… Console package created: Office-Auto-Installer-Console-$VERSION.zip"
        fi
        
        # Create comprehensive README for GUI package
        if [ -d "release-package-gui" ] && [ "$(ls -A release-package-gui)" ]; then
          cat > release-package-gui/README.txt << EOF
        Office Auto Installer - GUI Version Package - $VERSION
        ================================================================

        QUICK START INSTRUCTIONS:
        1. Extract both files to the same folder (like Downloads)
        2. Double-click "Install-Office-GUI-SAFE.bat" to start
        3. Click "Yes" when Windows asks for admin permission
        4. The beautiful GUI window will open with all options pre-configured
        5. Click "Install Office" (or customize settings first)

        WHAT'S INCLUDED:
        - Install-Office-GUI-SAFE.bat (Launcher for GUI version)
        - Install-Office-GUI-WPF.ps1 (Main GUI installer script)
        - README.txt (This file with instructions)

        FEATURES:
        - Windows 11 Fluent Design interface
        - Pre-filled defaults
        - Real-time progress tracking
        - One-click ready

        SYSTEM REQUIREMENTS:
        - Windows 10/11 (Windows 7/8 may work)
        - 4GB+ free disk space
        - 2GB+ RAM recommended
        - Internet connection (Office downloads during install)
        - Administrator privileges

        SUPPORTED OFFICE VERSIONS:
        - Office 2024 Pro Plus (Latest - Recommended)
        - Office LTSC 2021 (Stable long-term version)
        - Microsoft 365 Apps (Cloud-connected)

        SUPPORTED LANGUAGES:
        - English (US/UK), French, German, Dutch, Spanish, Portuguese

        OPTIONAL COMPONENTS:
        - Visio Professional (Diagrams and flowcharts)
        - Project Professional (Project management)

        TROUBLESHOOTING:
        If you have problems:
        1. Make sure both files are in the same folder
        2. Right-click the .bat file and "Run as administrator"
        3. Temporarily disable antivirus during installation
        4. Check your internet connection

        For more help, visit: https://njvanas.github.io/Office-Auto-Install/

        IMPORTANT DISCLAIMER:
        This tool uses Microsoft's official Office Deployment Tool.
        You are responsible for having proper Office licenses.
        This does not crack, modify, or bypass any licensing.

        Licensed under MIT License
        Copyright (c) 2025 Dolfie
        EOF
          
          # Create GUI ZIP package
          cd release-package-gui
          zip -r "../Office-Auto-Installer-GUI-$VERSION.zip" .
          cd ..
          echo "âœ… GUI package created: Office-Auto-Installer-GUI-$VERSION.zip"
        fi
        
        # Create complete package with all files
        mkdir -p release-package-complete
        if [ -f "Install-Office.ps1" ]; then cp Install-Office.ps1 release-package-complete/; fi
        if [ -f "Install-Office-SAFE.bat" ]; then cp Install-Office-SAFE.bat release-package-complete/; fi
        if [ -f "Install-Office-GUI-WPF.ps1" ]; then cp Install-Office-GUI-WPF.ps1 release-package-complete/; fi
        if [ -f "Install-Office-GUI-SAFE.bat" ]; then cp Install-Office-GUI-SAFE.bat release-package-complete/; fi
        if [ -f "README.md" ]; then cp README.md release-package-complete/; fi
        if [ -f "LICENSE" ]; then cp LICENSE release-package-complete/; fi
        
        if [ -d "release-package-complete" ] && [ "$(ls -A release-package-complete)" ]; then
          cat > release-package-complete/README.txt << EOF
        Office Auto Installer - Complete Package - $VERSION
        ================================================================

        This package contains both GUI and Console versions of the Office Auto Installer.

        QUICK START:
        Choose one version to use:

        GUI VERSION (RECOMMENDED):
        1. Extract all files to the same folder
        2. Double-click "Install-Office-GUI-SAFE.bat"
        3. Click "Yes" for admin permission
        4. Use the beautiful GUI interface

        CONSOLE VERSION:
        1. Extract all files to the same folder
        2. Double-click "Install-Office-SAFE.bat"
        3. Click "Yes" for admin permission
        4. Follow the text-based prompts

        WHAT'S INCLUDED:
        - Install-Office-GUI-SAFE.bat (GUI Launcher)
        - Install-Office-GUI-WPF.ps1 (GUI Installer)
        - Install-Office-SAFE.bat (Console Launcher)
        - Install-Office.ps1 (Console Installer)
        - README.md (Full documentation)
        - LICENSE (MIT License)

        For more help, visit: https://njvanas.github.io/Office-Auto-Install/

        Licensed under MIT License
        Copyright (c) 2025 Dolfie
        EOF
          
          cd release-package-complete
          zip -r "../Office-Auto-Installer-Complete-$VERSION.zip" .
          cd ..
          echo "âœ… Complete package created: Office-Auto-Installer-Complete-$VERSION.zip"
        fi
        
        echo "All packages created successfully!"
        ls -la *.zip

    - name: Generate changelog
      id: changelog
      run: |
        VERSION="${{ steps.check_release.outputs.final_version }}"
        
        # Get commits since last release
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -n "$LAST_TAG" ]; then
          COMMITS=$(git log $LAST_TAG..HEAD --oneline --pretty=format:"- %s" -- Install-Office.ps1 Install-Office-SAFE.bat Install-Office-GUI-WPF.ps1 Install-Office-GUI-SAFE.bat)
        else
          COMMITS=$(git log --oneline --pretty=format:"- %s" -10 -- Install-Office.ps1 Install-Office-SAFE.bat Install-Office-GUI-WPF.ps1 Install-Office-GUI-SAFE.bat)
        fi
        
        # Create changelog
        cat > changelog.md << EOF
        ## ðŸš€ Office Auto Installer $VERSION
        
        ### ðŸ“¥ Download Options
        - **GUI Version (Recommended)**: Download `Office-Auto-Installer-GUI-$VERSION.zip` for Windows 11 Fluent Design interface
        - **Console Version**: Download `Office-Auto-Installer-Console-$VERSION.zip` for text-based interface
        - **Complete Package**: Download `Office-Auto-Installer-Complete-$VERSION.zip` for both versions
        - **Individual Files**: Download the .ps1 and .bat files separately below
        - **All files must be in the same folder to work properly**
        
        ### ðŸ†• What's New
        $COMMITS
        
        ### âœ¨ Features
        - ðŸŽ¯ **Beginner-Friendly**: No technical knowledge required
        - ðŸ”’ **100% Safe**: Uses only official Microsoft tools
        - âš¡ **Fast Setup**: Automatic downloads and smart defaults
        - ðŸŽ¨ **Beautiful Interface**: Colorful, easy-to-read menus
        - ðŸ”§ **Flexible Options**: Choose Office version, language, and components
        - ðŸ›¡ï¸ **Error Protection**: Built-in troubleshooting and help
        
        ### ðŸ–¥ï¸ Supported Office Versions
        - **Office 2024 Pro Plus** (Latest with newest features)
        - **Office LTSC 2021** (Stable, less frequent updates)
        - **Microsoft 365 Apps** (Cloud-connected with online features)
        
        ### ðŸŒ Supported Languages
        English (US/UK), French, German, Dutch, Spanish, Portuguese (Brazil)
        
        ### ðŸ“‹ System Requirements
        - Windows 10/11 (Windows 7/8 may work)
        - 4GB+ free disk space
        - 2GB+ RAM recommended
        - Internet connection required
        - Administrator privileges
        
        ### ðŸš€ Quick Start
        
        **GUI Version (Recommended):**
        1. Download `Office-Auto-Installer-GUI-$VERSION.zip`
        2. Extract both files to the same folder
        3. Double-click \`Install-Office-GUI-SAFE.bat\`
        4. Click "Yes" for admin permission
        5. Use the beautiful GUI interface
        
        **Console Version:**
        1. Download `Office-Auto-Installer-Console-$VERSION.zip`
        2. Extract both files to the same folder
        3. Double-click \`Install-Office-SAFE.bat\`
        4. Click "Yes" for admin permission
        5. Follow the text-based prompts
        
        ### ðŸ†˜ Need Help?
        - ðŸ“– **Full Documentation**: [Visit our website](https://njvanas.github.io/Office-Auto-Install/)
        - ðŸ› **Report Issues**: [GitHub Issues](https://github.com/njvanas/Office-Auto-Install/issues)
        - ðŸ’¬ **Get Support**: Check the troubleshooting section in README.txt
        
        ### âš ï¸ Important Notes
        - This tool uses Microsoft's official Office Deployment Tool
        - **You must have proper Office licenses** - this doesn't provide licenses
        - No cracking, patching, or license bypassing is performed
        - Use at your own risk and ensure license compliance
        
        ---
        
        **Installation Time**: 10-30 minutes depending on internet speed  
        **Perfect for**: Home users, small businesses, IT support, students  
        **License**: MIT License - Free to use and modify
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.check_release.outputs.final_version }}
        name: "Office Auto Installer ${{ steps.check_release.outputs.final_version }}"
        body_path: changelog.md
        files: |
          Office-Auto-Installer-GUI-${{ steps.check_release.outputs.final_version }}.zip
          Office-Auto-Installer-Console-${{ steps.check_release.outputs.final_version }}.zip
          Office-Auto-Installer-Complete-${{ steps.check_release.outputs.final_version }}.zip
          Install-Office.ps1
          Install-Office-SAFE.bat
          Install-Office-GUI-WPF.ps1
          Install-Office-GUI-SAFE.bat
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update latest release info
      run: |
        VERSION="${{ steps.check_release.outputs.final_version }}"
        echo "âœ… Release $VERSION created successfully!"
        echo "ðŸ“¦ GUI package: Office-Auto-Installer-GUI-$VERSION.zip"
        echo "ðŸ“¦ Console package: Office-Auto-Installer-Console-$VERSION.zip"
        echo "ðŸ“¦ Complete package: Office-Auto-Installer-Complete-$VERSION.zip"
        echo "ðŸ”— Release URL: https://github.com/njvanas/Office-Auto-Install/releases/tag/$VERSION"
        echo "ðŸŒ Download page: https://njvanas.github.io/Office-Auto-Install/"
